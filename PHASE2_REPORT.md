# Phase 2 진행 보고서: HWP(바이너리) 지원 검토 및 구현

## 1) Phase 1 완료 상태 검토 및 Phase 2 진행 가능 여부

- 현재 코드베이스는 HWPX 중심 구조이지만, 스토리지/연산 계층(`storage.py`, `hwpx_ops.py`)이 비교적 분리되어 있어 확장 포인트가 명확했습니다.
- 도구 스키마/핸들링(`tools.py`)은 `path` 기반 단일 인터페이스를 유지하고 있어, 확장자 분기만 추가하면 하위 호환을 유지한 채 HWP 지원을 넣을 수 있습니다.
- 결론: **Phase 2 진행 가능**.

## 2) 구현 전 기술 검토 (라이브러리 조사)

### 2.1 검토 대상
- `olefile`
- `pyhwp`
- (참고) 한컴 HWP Binary 스펙 기반 접근

### 2.2 실제 확인 내용
- `olefile`:
  - Python 3.12 환경에서 설치/사용 가능 확인.
  - OLE 스트림 단위로 `PrvText`, `BodyText/Section*` 접근 가능.
- `pyhwp`:
  - Python 3.12 환경에서 설치 성공 확인.
  - 다만 본 저장소에 유의미한 샘플 `.hwp`가 없어 실제 문서 파싱 품질(표/스타일 완전성)까지는 본 단계에서 계량 검증 어려움.

### 2.3 접근법 비교
- A) HWP→HWPX 자동 변환: 고품질 변환기 의존성이 커서 즉시 안정화 난이도 높음.
- B) HWP 전용 편집 파서 구현: 구현량/검증량 과대.
- C) HWP 읽기 전용 + 편집은 HWPX 유도: 기존 도구 인터페이스 유지, 리스크 최소, 즉시 실용성 확보.

### 2.4 선택안
- **C안 채택**: `.hwp`는 읽기/검색/문단 조회를 제공하고, 편집 도구는 명확한 오류 메시지로 HWPX 변환을 안내.

## 3) 구현 내용

### 3.1 신규 모듈
- `src/hwpx_mcp_server/hwp_support.py`
  - OLE 기반 `.hwp` 텍스트 추출 유틸 추가.
  - 우선순위:
    1. `PrvText`(프리뷰 텍스트)
    2. `BodyText/Section*` 압축 해제 후 UTF-16 텍스트 조각 추출
  - `HwpTextSnapshot`, `HwpBinaryError` 도입.

### 3.2 연산 계층 통합
- `src/hwpx_mcp_server/hwpx_ops.py`
  - `.hwp` 감지 시 읽기 전용 파이프라인 분기 추가.
  - 지원 도구:
    - `open_info` (형식/읽기전용/추출소스 메타 포함)
    - `read_text`
    - `get_paragraphs`
    - `text_extract_report`
    - `find`
  - 편집 계열 도구는 `.hwp`에서 실행 시 명확한 예외 메시지 반환:
    - “HWP(.hwp)는 현재 읽기 전용입니다. 편집 작업은 HWPX로 변환 후 다시 시도하세요.”

### 3.3 의존성 추가
- `pyproject.toml`
  - `olefile>=0.47` 추가.

### 3.4 문서 반영
- `README.md`
  - HWP 읽기 전용 호환 기능 안내 추가.

## 4) 테스트 결과

### 4.1 자동 테스트
- 기존 테스트 + 신규 테스트 반영.
- 신규 시나리오:
  - HWP `open_info` 읽기전용 메타 검증
  - HWP `read_text`/`find` 동작 검증
  - HWP 편집 시 명확한 오류 메시지 검증

### 4.2 한계
- 실제 실문서 `.hwp` 샘플(표/스타일 복합 케이스) 기반 정밀 품질 테스트는 리포지토리 내 샘플 부재로 후속 보완 필요.

## 5) 사용자 영향도

- 하위 호환성: 기존 HWPX 동작 유지.
- 개선점: `.hwp`를 열었을 때 즉시 텍스트 조회/검색 가능.
- 제한: `.hwp` 편집은 미지원(명시적 안내 제공).

## 6) 다음 단계 제안

1. 실제 업무용 `.hwp` 샘플셋(일반 문단/표/각주/스타일 포함) 확보
2. `pyhwp` 기반 보조 추출 경로(옵션) 추가 검토
3. 필요 시 Phase 2.5로 “HWP→HWPX 변환 어댑터(외부 변환기 연계)” PoC 수행
